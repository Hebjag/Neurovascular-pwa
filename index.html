<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Neurovascular Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .form-section {
            transition: all 0.4s ease-in-out;
            overflow: hidden;
            max-height: 1000px;
        }
        .form-section.hidden {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            opacity: 0;
        }
        select, input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 2px solid rgba(255,255,255,.3);
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Neurovascular Calculator</h1>
                <p class="text-gray-400 mt-2">AVM & Aneurysm Risk Stratification</p>
            </header>

            <main>
                <!-- Disclaimer -->
                <div class="bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">For Educational Use Only.</strong>
                    <span class="block sm:inline ml-1">This tool is not a substitute for professional medical or neurosurgical judgment.</span>
                </div>

                <form id="score-form" class="space-y-6">
                    <!-- Pathology Selection -->
                    <div>
                        <label for="pathology-select" class="block text-sm font-medium text-gray-300 mb-2">1. Select Pathology</label>
                        <select id="pathology-select" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-gray-200">
                            <option value="avm">Arteriovenous Malformation (AVM)</option>
                            <option value="aneurysm">Unruptured Aneurysm</option>
                        </select>
                    </div>

                    <!-- AVM SCORING SECTION -->
                    <div id="avm-section" class="space-y-6 form-section">
                        <div>
                            <label for="avm-model-select" class="block text-sm font-medium text-gray-300 mb-2">2. Select AVM Score</label>
                            <select id="avm-model-select" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-gray-200">
                                <option value="pmars">P-MARS (Pollock-Flickinger) - Radiosurgery</option>
                                <option value="rbas">Modified RBAS - Radiosurgery</option>
                                <option value="spetzler-martin">Spetzler-Martin - Microsurgery</option>
                                <option value="spetzler-ponce">Spetzler-Ponce (Modified Lawton) - Microsurgery</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ANEURYSM SCORING SECTION -->
                    <div id="aneurysm-section" class="space-y-6 form-section hidden">
                         <div>
                            <label for="aneurysm-model-select" class="block text-sm font-medium text-gray-300 mb-2">2. Select Aneurysm Score</label>
                            <select id="aneurysm-model-select" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-gray-200">
                                <option value="phases">PHASES</option>
                                <option value="isuia">ISUIA</option>
                                <option value="elaps">ELAPS</option>
                            </select>
                        </div>
                    </div>

                    <!-- COMMON & DYNAMIC INPUTS SECTION -->
                    <div id="dynamic-inputs" class="space-y-6"></div>

                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500">
                        Calculate
                    </button>
                </form>

                <!-- Results Section -->
                <div id="results" class="mt-8 text-center hidden">
                    <div id="result-card" class="p-6 rounded-lg transition-colors duration-500">
                        <p class="text-sm font-medium uppercase tracking-wider" id="result-label">Result</p>
                        <p class="text-4xl md:text-5xl font-bold my-2" id="result-value">0</p>
                        <p class="text-base" id="result-description">Description of outcome.</p>
                    </div>
                     <div class="grid grid-cols-2 gap-4 mt-4" id="sub-results">
                        <!-- Sub results like diameter, score etc. -->
                     </div>
                </div>
                 <div id="error-message" class="mt-4 text-center text-red-400 font-medium hidden"></div>

                 <!-- GEMINI API SECTION -->
                <div id="gemini-section" class="mt-8 border-t-2 border-gray-700 pt-6 hidden">
                    <h3 class="text-xl font-bold text-center text-white mb-4">✨ AI Assistant</h3>
                    <div id="gemini-actions" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <button id="gemini-clinician" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">Summarize for Clinician</button>
                        <button id="gemini-patient" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">Explain for Patient</button>
                        <button id="gemini-report" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">Draft Report Note</button>
                    </div>
                    <div id="gemini-output" class="bg-gray-900 p-4 rounded-lg min-h-[100px] relative">
                        <div id="gemini-loading" class="absolute inset-0 bg-gray-900/80 flex items-center justify-center hidden">
                            <div class="spinner w-6 h-6 rounded-full"></div>
                            <span class="ml-3">Generating...</span>
                        </div>
                        <div id="gemini-result-text" class="whitespace-pre-wrap text-gray-300"></div>
                        <button id="copy-button" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 p-2 rounded-md hidden" title="Copy to clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                        </button>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const pathologySelect = document.getElementById('pathology-select');
        const avmSection = document.getElementById('avm-section');
        const aneurysmSection = document.getElementById('aneurysm-section');
        const avmModelSelect = document.getElementById('avm-model-select');
        const aneurysmModelSelect = document.getElementById('aneurysm-model-select');
        const dynamicInputsContainer = document.getElementById('dynamic-inputs');
        const scoreForm = document.getElementById('score-form');
        const resultsDiv = document.getElementById('results');
        const errorMessageDiv = document.getElementById('error-message');
        
        // --- GEMINI Elements ---
        const geminiSection = document.getElementById('gemini-section');
        const geminiClinicianBtn = document.getElementById('gemini-clinician');
        const geminiPatientBtn = document.getElementById('gemini-patient');
        const geminiReportBtn = document.getElementById('gemini-report');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResultText = document.getElementById('gemini-result-text');
        const copyButton = document.getElementById('copy-button');
        
        let lastResultForGemini = null;

        // --- Input Field Templates ---
        const fieldTemplates = {
            avmDimensions: `
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">AVM Dimensions (mm)</label>
                    <div class="grid grid-cols-3 gap-4">
                        <input type="number" id="size-x" step="0.1" min="0" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg" placeholder="X" required>
                        <input type="number" id="size-y" step="0.1" min="0" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg" placeholder="Y" required>
                        <input type="number" id="size-z" step="0.1" min="0" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg" placeholder="Z" required>
                    </div>
                </div>`,
            aneurysmSize: `
                <div>
                    <label for="aneurysm-size" class="block text-sm font-medium text-gray-300 mb-2">Aneurysm Max Diameter (mm)</label>
                    <input type="number" id="aneurysm-size" step="0.1" min="0" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg" placeholder="e.g., 7.5" required>
                </div>`,
            patientAge: `
                <div>
                    <label for="patient-age" class="block text-sm font-medium text-gray-300 mb-2">Patient Age (years)</label>
                    <input type="number" id="patient-age" min="0" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg" placeholder="e.g., 55" required>
                </div>`,
            brainEloquence: `
                <div>
                    <label for="avm-location" class="block text-sm font-medium text-gray-300 mb-2">AVM Location (Eloquence)</label>
                    <select id="avm-location" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 transition text-gray-200">
                        <option value="1">Primary motor cortex</option>
                        <option value="1">Primary sensory cortex</option>
                        <option value="1">Primary visual cortex</option>
                        <option value="1">Language areas (Wernicke's, Broca's)</option>
                        <option value="1">Thalamus or Hypothalamus</option>
                        <option value="1">Brainstem</option>
                        <option value="1">Cerebellar peduncles or Deep Cerebellar Nuclei</option>
                        <option value="0">Non-eloquent location / Other</option>
                    </select>
                </div>`,
            venousDrainage: `
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Venous Drainage</label>
                    <div class="flex items-center space-x-4 mt-2"><label class="flex items-center"><input type="radio" name="venous" value="0" class="h-4 w-4 text-indigo-600" checked><span class="ml-2">Superficial</span></label><label class="flex items-center"><input type="radio" name="venous" value="1" class="h-4 w-4 text-indigo-600"><span class="ml-2">Deep</span></label></div>
                </div>`,
            rupturedState: `
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">History of Rupture (SAH)</label>
                    <div class="flex items-center space-x-4 mt-2"><label class="flex items-center"><input type="radio" name="bleeding" value="0" class="h-4 w-4 text-indigo-600" checked><span class="ml-2">No (Unruptured)</span></label><label class="flex items-center"><input type="radio" name="bleeding" value="1" class="h-4 w-4 text-indigo-600"><span class="ml-2">Yes (Ruptured)</span></label></div>
                </div>`,
            nidusCompactness: `
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nidus Compactness</label>
                    <div class="flex items-center space-x-4 mt-2"><label class="flex items-center"><input type="radio" name="nidus" value="0" class="h-4 w-4 text-indigo-600" checked><span class="ml-2">Compact</span></label><label class="flex items-center"><input type="radio" name="nidus" value="1" class="h-4 w-4 text-indigo-600"><span class="ml-2">Diffuse</span></label></div>
                </div>`,
            population: `
                <div>
                    <label for="population" class="block text-sm font-medium text-gray-300 mb-2">Population</label>
                    <select id="population" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg"><option value="na_eu">North American / European</option><option value="jp_fi">Japanese / Finnish</option></select>
                </div>`,
            hypertension: `
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">History of Hypertension</label>
                    <div class="flex items-center space-x-4 mt-2"><label class="flex items-center"><input type="radio" name="hypertension" value="0" class="h-4 w-4 text-indigo-600" checked><span class="ml-2">No</span></label><label class="flex items-center"><input type="radio" name="hypertension" value="1" class="h-4 w-4 text-indigo-600"><span class="ml-2">Yes</span></label></div>
                </div>`,
            aneurysmLocation: `
                <div>
                    <label for="aneurysm-location" class="block text-sm font-medium text-gray-300 mb-2">Aneurysm Location</label>
                    <select id="aneurysm-location" class="w-full p-3 bg-gray-900 border-2 border-gray-700 rounded-lg"><option value="aca_mca_ica">ACA / MCA / Ant. Comm / ICA</option><option value="posterior">Posterior (inc. PComm)</option><option value="cavernous">Cavernous Artery</option></select>
                </div>`
        };

        // --- Logic to Render Dynamic Fields ---
        function renderDynamicFields() {
            const pathology = pathologySelect.value;
            let model, requiredFields = [];
            
            // Clear previous inputs before rendering new ones
            dynamicInputsContainer.innerHTML = '';
            resultsDiv.classList.add('hidden');
            hideError();

            if (pathology === 'avm') {
                model = avmModelSelect.value;
                requiredFields.push('avmDimensions', 'patientAge');
                if (model === 'pmars' || model === 'rbas' || model === 'spetzler-martin' || model === 'spetzler-ponce') {
                    requiredFields.push('brainEloquence');
                }
                if (model === 'spetzler-martin' || model === 'spetzler-ponce') {
                    requiredFields.push('venousDrainage');
                }
                if (model === 'spetzler-ponce') {
                    requiredFields.push('rupturedState', 'nidusCompactness');
                }
            } else { // Aneurysm
                model = aneurysmModelSelect.value;
                requiredFields.push('aneurysmSize', 'patientAge', 'aneurysmLocation', 'population', 'rupturedState');
                if (model === 'phases') {
                    requiredFields.push('hypertension');
                }
            }
            
            dynamicInputsContainer.innerHTML = requiredFields.map(field => fieldTemplates[field]).join('');
        }
        
        // --- Event Listeners ---
        pathologySelect.addEventListener('change', () => {
            const isAVM = pathologySelect.value === 'avm';
            avmSection.classList.toggle('hidden', !isAVM);
            aneurysmSection.classList.toggle('hidden', isAVM);
            renderDynamicFields();
        });
        
        // ... existing event listeners ...

        scoreForm.addEventListener('submit', (e) => {
            e.preventDefault();
            calculateScore();
        });

        // --- Gemini API Call Logic ---
        async function callGeminiAPI(prompt) {
            geminiLoading.classList.remove('hidden');
            geminiResultText.textContent = '';
            copyButton.classList.add('hidden');
            
            const apiKey = ""; // API key will be injected by the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    geminiResultText.textContent = text;
                    copyButton.classList.remove('hidden');
                } else {
                    throw new Error("No content received from API.");
                }
            } catch (error) {
                geminiResultText.textContent = `Error: Could not retrieve analysis. ${error.message}`;
            } finally {
                geminiLoading.classList.add('hidden');
            }
        }
        
        // --- Gemini Button Event Listeners ---
        geminiClinicianBtn.addEventListener('click', () => {
            if (!lastResultForGemini) return;
            const { scoreLabel, resultText, description, subResults } = lastResultForGemini;
            const prompt = `You are a senior neurovascular specialist. A patient's case has been evaluated using the ${scoreLabel} score, resulting in a value of "${resultText}". This indicates: "${description}". The key parameters were: ${JSON.stringify(subResults)}.
            
            Briefly summarize the clinical implications of this score in 2-4 sentences for a junior doctor or resident, focusing on risk and potential treatment considerations.`;
            callGeminiAPI(prompt);
        });

        geminiPatientBtn.addEventListener('click', () => {
            if (!lastResultForGemini) return;
            const { scoreLabel, resultText, description } = lastResultForGemini;
            const prompt = `You are a compassionate neurologist explaining a complex topic to a patient. We used a standard scoring system called the "${scoreLabel}" to better understand your situation. The result was "${resultText}", which suggests the following: "${description}".
            
            Please rephrase this information in simple, reassuring, and easy-to-understand terms. Explain what the result means for them without using complex medical jargon. Address the patient directly and kindly.`;
            callGeminiAPI(prompt);
        });

        geminiReportBtn.addEventListener('click', () => {
            if (!lastResultForGemini) return;
            const { scoreLabel, resultText, description, subResults } = lastResultForGemini;
            const prompt = `You are an AI assistant drafting a clinical note for an electronic health record. Based on the following data, generate a concise, formal note.
            
            - Scoring System: ${scoreLabel}
            - Result: ${resultText}
            - Interpretation: ${description}
            - Supporting Data: ${JSON.stringify(subResults)}
            
            Draft a clinical note in a standard format, starting with "Neurovascular risk assessment:" and summarizing the findings.`;
            callGeminiAPI(prompt);
        });
        
        copyButton.addEventListener('click', () => {
            const textToCopy = geminiResultText.textContent;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyButton.innerHTML = 'Copied!';
                setTimeout(() => {
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea);
        });


        // --- Calculation Logic ---
        function calculateScore() {
            // ... (rest of the function is unchanged)
            try {
                const pathology = pathologySelect.value;
                let result;
                if (pathology === 'avm') {
                    result = calculateAVMScore();
                } else {
                    result = calculateAneurysmScore();
                }
                displayResults(result);

            } catch (error) {
                console.error(error);
                showError("Please ensure all fields are filled correctly.");
            }
        }
        
        // ... (calculateAVMScore and calculateAneurysmScore functions are unchanged) ...
        function calculateAVMScore() {
            const model = avmModelSelect.value;
            const x = getVal('size-x');
            const y = getVal('size-y');
            const z = getVal('size-z');
            const age = getVal('patient-age');

            const max_dim_cm = Math.max(x, y, z) / 10;
            const volume_cm3 = (Math.PI / 6) * x * y * z / 1000;
            
            let eloquence, venous_drainage, ruptured, nidus;
            let score, resultText, description, scoreLabel, colorizeValue;
            let subResults = {'Calculated Volume': `${volume_cm3.toFixed(2)} cm³`, 'Max Diameter': `${max_dim_cm.toFixed(1)} cm`};

            if (document.getElementById('avm-location')) {
                 eloquence = parseInt(getSelect('avm-location'));
            }
            if (document.querySelector('input[name="venous"]')) {
                venous_drainage = getRadio('venous');
            }
            if (document.querySelector('input[name="bleeding"]')) {
                ruptured = getRadio('bleeding');
            }
             if (document.querySelector('input[name="nidus"]')) {
                nidus = getRadio('nidus');
            }

            switch (model) {
                case 'pmars':
                    score = (0.1 * volume_cm3) + (0.02 * age) + (0.3 * eloquence);
                    const probability_pmars = 1 / (1 + Math.exp(score)) * 100;
                    resultText = `${probability_pmars.toFixed(1)}%`;
                    description = '3-year obliteration probability without new deficit.';
                    scoreLabel = 'P-MARS Score';
                    colorizeValue = probability_pmars;
                    subResults[scoreLabel] = score.toFixed(2);
                    break;
                case 'rbas':
                    const age_decades = age / 10;
                    score = (0.23 * volume_cm3) + (0.21 * age_decades) + (1.12 * eloquence);
                    const probability_rbas = Math.max(0, 95.1 - (10.3 * score));
                    resultText = `${probability_rbas.toFixed(1)}%`;
                    description = 'Obliteration probability without neurological deficit.';
                    scoreLabel = 'Modified RBAS';
                    colorizeValue = probability_rbas;
                    subResults[scoreLabel] = score.toFixed(2);
                    break;
                case 'spetzler-martin':
                    const size_pts_sm = max_dim_cm < 3 ? 1 : (max_dim_cm <= 6 ? 2 : 3);
                    score = size_pts_sm + eloquence + venous_drainage;
                    const risk_map = {1: '2-4%', 2: '5-7%', 3: '12-15%', 4: '20-22%', 5: '29-31%', 6: 'Inoperable'};
                    resultText = `Grade ${score}`;
                    description = `Approx. ${risk_map[score] || '>30%'} risk of major post-op deficit.`;
                    scoreLabel = 'Spetzler-Martin Grade';
                    colorizeValue = (6 - score) * 16.67;
                    break;
                case 'spetzler-ponce':
                    const size_pts_sp = max_dim_cm < 3 ? 1 : (max_dim_cm <= 6 ? 2 : 3);
                    const sm_base = size_pts_sp + eloquence + venous_drainage;
                    const age_pts_sp = age < 20 ? 1 : (age <= 40 ? 2 : 3);
                    const supp_score = age_pts_sp + ruptured + nidus;
                    score = sm_base + supp_score;
                    resultText = `${score} points`;
                    description = 'Combined score for microsurgical risk.';
                    scoreLabel = 'Spetzler-Ponce Score';
                    colorizeValue = Math.max(0, 100 - (score * 10));
                    subResults['Base S-M Grade'] = sm_base;
                    subResults['Supp. Score'] = supp_score;
                    break;
            }
            return { score, resultText, description, scoreLabel, colorizeValue, subResults };
        }
        
        function calculateAneurysmScore() {
            const model = aneurysmModelSelect.value;
            const size = getVal('aneurysm-size');
            const age = getVal('patient-age');
            const location = getSelect('aneurysm-location');
            const hasSAH = getRadio('bleeding');
            const population = getSelect('population');
            
            let score, resultText, description, scoreLabel, colorizeValue;
            let subResults = {};
            
            switch(model) {
                case 'phases': {
                    const popPts = population === 'jp_fi' ? 3 : 0;
                    const hypertension = getRadio('hypertension') === 1 ? 1 : 0;
                    const agePts = age >= 70 ? 1 : 0;
                    const sizePts = size < 7 ? 0 : (size < 10 ? 3 : (size < 20 ? 6 : 10));
                    const sahPts = hasSAH;
                    const sitePts = location === 'posterior' ? 4 : 0;
                    
                    score = popPts + hypertension + agePts + sizePts + sahPts + sitePts;
                    const risk_5y = (1 - Math.pow(0.99136, Math.exp(0.2454 * (score - 5.155)))) * 100;
                    
                    resultText = risk_5y.toFixed(1) + '%';
                    description = '5-Year Rupture Risk';
                    scoreLabel = 'PHASES Score';
                    colorizeValue = 100 - (risk_5y * 4); // Scale for coloring
                    subResults['PHASES Score'] = score;
                    break;
                }
                case 'isuia': {
                    scoreLabel = 'ISUIA';
                    description = '5-Year Rupture Risk';
                    let risk_5y = 0;
                    
                    if (location === 'cavernous') {
                        risk_5y = 0; 
                    } else if (hasSAH) {
                        if (location === 'posterior') {
                           if (size < 7) risk_5y = 2.1; else if (size < 13) risk_5y = 7.5; else if (size < 25) risk_5y = 9.8; else risk_5y = 14.7;
                        } else {
                           if (size < 7) risk_5y = 1.9; else if (size < 13) risk_5y = 3.6; else if (size < 25) risk_5y = 11.5; else risk_5y = 14.5;
                        }
                    } else { // No SAH
                        if (population === 'jp_fi') {
                            if (location === 'posterior') {
                                if (size < 7) risk_5y = 3.4; else if (size < 13) risk_5y = 14.5; else if (size < 25) risk_5y = 40; else risk_5y = 50;
                            } else {
                                if (size < 7) risk_5y = 2.5; else if (size < 13) risk_5y = 5.3; else if (size < 25) risk_5y = 22; else risk_5y = 26;
                            }
                        } else { // N.America/Europe
                            if (location === 'posterior') {
                                if (size < 7) risk_5y = 2.5; else if (size < 13) risk_5y = 14.5; else if (size < 25) risk_5y = 40; else risk_5y = 50;
                            } else {
                                if (size < 7) risk_5y = 0; else if (size < 13) risk_5y = 2.6; else if (size < 25) risk_5y = 14.5; else risk_5y = 40;
                            }
                        }
                    }
                    resultText = risk_5y.toFixed(1) + '%';
                    colorizeValue = 100 - (risk_5y * 4);
                    break;
                }
                case 'elaps': {
                    const sahPts = hasSAH * 4;
                    const locPts = (location === 'aca_mca_ica' && confirm("Is the location Middle Cerebral Artery (MCA)?")) ? 2 : 0;
                    const agePts = age > 60 ? 1 : 0;
                    const popPts = population === 'jp_fi' ? 3 : 0;
                    const sizePts = size >= 7 ? 6 : 0;
                    score = sahPts + locPts + agePts + popPts + sizePts;
                    const risks = {0:0.4, 1:0.6, 2:0.8, 3:1.2, 4:1.7, 5:2.4, 6:3.3, 7:4.7, 8:6.5, 9:8.9, 10:12.1, 11:16.2, 12:21.3, 13:27.5, 14:34.5, 15:42.2, 16:50.2}; // 5y risk
                    const risk_5y = risks[Math.round(score)] || 50;
                    
                    resultText = risk_5y.toFixed(1) + '%';
                    description = '5-Year Rupture Risk';
                    scoreLabel = 'ELAPS Score';
                    colorizeValue = 100 - (risk_5y * 3);
                    subResults['ELAPS Score'] = score;
                    break;
                }
            }
             return { score, resultText, description, scoreLabel, colorizeValue, subResults };
        }
        
        // --- Display and Error Functions ---
        function displayResults(result) {
            hideError();
            const { resultText, description, scoreLabel, colorizeValue, subResults } = result;
            const resultCard = document.getElementById('result-card');
            
            document.getElementById('result-label').textContent = scoreLabel;
            document.getElementById('result-value').textContent = resultText;
            document.getElementById('result-description').textContent = description;

            const subResultsContainer = document.getElementById('sub-results');
            subResultsContainer.innerHTML = '';
            if (subResults) {
                for (const [key, value] of Object.entries(subResults)) {
                    const box = document.createElement('div');
                    box.className = 'bg-gray-700/50 p-3 rounded-lg';
                    box.innerHTML = `<p class="text-xs text-gray-400">${key}</p><p class="font-semibold text-lg">${value}</p>`;
                    subResultsContainer.appendChild(box);
                }
            }

            resultCard.classList.remove('bg-green-800', 'bg-yellow-800', 'bg-red-800');
            if (colorizeValue > 66) resultCard.classList.add('bg-green-800');
            else if (colorizeValue > 33) resultCard.classList.add('bg-yellow-800');
            else resultCard.classList.add('bg-red-800');
            
            resultsDiv.classList.remove('hidden');
            
            // Show Gemini section and save the result
            lastResultForGemini = result;
            geminiSection.classList.remove('hidden');
            geminiResultText.textContent = 'Select an action above to generate an AI summary.';
            copyButton.classList.add('hidden');
        }
        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            geminiSection.classList.add('hidden');
        }
        function hideError() {
            errorMessageDiv.classList.add('hidden');
        }

        // Initial setup
        pathologySelect.dispatchEvent(new Event('change'));
        renderDynamicFields();

    </script>
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                      navigator.serviceWorker.register('service-worker.js')
                        .then(reg => console.log('Service Worker registered:', reg))
                        .catch(err => console.log('Service Worker registration failed:', err));
                });
            }
        </script>
</body>
</html>
